name: LinkNote Workflow
on:
  push:
    branches:
      - 'release/**'
    paths-ignore:
      - "readme.md"
      - "doc/**"
      - "attachment/**"
      - "LICENSE"
      - "docker-compose.dev.yml"
      - "*.md"
  pull_request:
    branches:
      - 'release/**'
    paths-ignore:
      - "readme.md"
      - "doc/**"
      - "attachment/**"
      - "LICENSE"
      - "docker-compose.dev.yml"
      - "*.md"


jobs:
  # This job do the followings:
  # 1. Build project
  # 2. Unit Tests
  # 3. Integration Tests
  # 4. Build docker image
  build-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [ 17, 21 ]

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from branch name and create full version
        id: set_version
        run: |
          VERSION=$(echo $GITHUB_REF | sed 's/refs\/heads\/release\/v//')
          CURRENT_DATE=$(date +'%Y%m%d')
          FULL_VERSION="${VERSION}-${CURRENT_DATE}-${GITHUB_RUN_NUMBER}"
          echo "FULL_VERSION=${FULL_VERSION}" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: 'adopt'

      - name: Set up the Maven dependencies caching
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{runner.os}}-m2-${{hashFiles('**/pom.xml')}}
          restore-keys: ${{runner.os}}-m2

      - name: Install Maven Dependencies
        run: mvn -f server/pom.xml install

      - name: Run tests
        run: mvn --file server/pom.xml --batch-mode --update-snapshots verify

      ### Build image for Functionality Test

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and AMD64 image for testing
        uses: docker/build-push-action@v5
        with:
          context: ./server
          tags: linklabs1117/linknote-server:${{ env.FULL_VERSION }}
          platforms: linux/amd64
          load: true
      #


      ### Run the linknote-server from image
      - name: Start whole service
        run: docker-compose -p linknote -f docker-compose.test.yml up -d
        env:
          VERSION: ${{ env.FULL_VERSION }}

      ### Switch to Java-17 and run the rest assure test

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'adopt'
      - run: echo "JAVA_17=$JAVA_HOME" >> $GITHUB_ENV

      - name: Set up the Maven dependencies caching
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{runner.os}}-m2-${{hashFiles('**/pom.xml')}}
          restore-keys: ${{runner.os}}-m2

      - name: Set environment variable for tests
        run: echo "TEST_BASE_URL=http://localhost:8080" >> $GITHUB_ENV

      - name: Run functionality tests
        run: mvn --file serverTest/apiFunctionalityTest/pom.xml test


      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ARM64/AMD64
        uses: docker/build-push-action@v5
        with:
          context: ./server
          platforms: linux/amd64,linux/arm64
          push: true
          tags: linklabs1117/linknote-server:${{ env.FULL_VERSION }}



  #todo:
  # This job do the followings:
  # 1. if all the tests are finished, request merge into "main"
  # 2. deploy on the real prod-env
#  jobs:
#    if: ${{ github.ref == 'refs/heads/main' }}
#    needs:
#      - api-functionality-test
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@4





